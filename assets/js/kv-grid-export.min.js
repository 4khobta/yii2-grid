/*!
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2013
 * @version 2.1.0
 *
 * Grid Export Validation Module for Yii's Gridview. Supports export of
 * grid data as CSV, HTML, or Excel.
 *
 * Author: Kartik Visweswaran
 * Copyright: 2014, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */function replaceAll(e,t,o){return e.split(t).join(o)}!function(e){var t='<!DOCTYPE html><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1"/>{css}<style>.kv-wrap{padding:20px;}.kv-align-center{text-align:center;}.kv-align-left{text-align:left;}.kv-align-right{text-align:right;}.kv-align-top{vertical-align:top!important;}.kv-align-bottom{vertical-align:bottom!important;}.kv-align-middle{vertical-align:middle!important;}.kv-page-summary{border-top:4px double #ddd;font-weight: bold;}.kv-table-footer{border-top:4px double #ddd;font-weight: bold;}.kv-table-caption{font-size:1.5em;padding:8px;border:1px solid #ddd;border-bottom:none;}</style><body class="kv-wrap">{data}</body>',o='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>{css}<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>{data}</body></html>',r=function(t,o){this.$element=e(t),this.$grid=o.grid,this.$table=this.$grid.find("table"),this.$form=this.$grid.find("form.kv-export-form"),e("body").length&&this.$form.appendTo("body"),this.filename=o.filename,this.showHeader=o.showHeader,this.columns=o.showHeader?"td,th":"td",this.worksheet=o.worksheet,this.colDelimiter=o.colDelimiter,this.rowDelimiter=o.rowDelimiter,this.alertMsg=o.alertMsg,this.browserPopupsMsg=o.browserPopupsMsg,this.cssFile=o.cssFile,this.exportConversions=o.exportConversions,this.listen()};r.prototype={constructor:r,notify:function(){var e=this,t=e.alertMsg.length?e.alertMsg:"",o=e.browserPopupsMsg.length?e.browserPopupsMsg:"",r="";if(t.length&&o.length)r=t+"\n\n"+o;else if(!t.length&&o.length)r=o;else{if(!t.length||o.length)return;r=t}},listen:function(){var e=this;e.$form.on("submit",function(){setTimeout(function(){e.$grid.yiiGridView("applyFilter")},500)}),e.$element.hasClass("export-csv")?e.$element.on("click",function(t){e.notify(),e.exportTEXT("csv"),t.preventDefault()}):e.$element.hasClass("export-txt")?e.$element.on("click",function(t){e.notify(),e.exportTEXT("txt"),t.preventDefault()}):e.$element.hasClass("export-html")?e.$element.on("click",function(t){e.notify(),e.exportHTML(),t.preventDefault()}):e.$element.hasClass("export-xls")&&e.$element.on("click",function(t){e.notify(),e.exportEXCEL(),t.preventDefault()})},clean:function(e){var t=this,o=t.$table.clone();o.find("tr.filters").remove(),o.find("th").removeAttr("rowspan"),t.showHeader||o.find("thead").remove(),t.showPageSummary||o.find("tfoot.kv-page-summary").remove(),t.showFooter||o.find("tfoot.kv-table-footer").remove(),t.showCaption||o.find("kv-table-caption").remove(),o.find(".skip-export").remove(),o.find(".skip-export-"+e).remove();var r=o.html();return r=t.preProcess(r),o.html(r),o},preProcess:function(e){var t=this,o=t.exportConversions,r=o.length,n=e;if(r>0)for(var i=0;r>i;i++)n=replaceAll(n,o[i].from,o[i].to);return n},download:function(e,t){var o=this;o.$form.find('[name="export_filetype"]').val(e),o.$form.find('[name="export_filename"]').val(o.filename),o.$form.find('[name="export_content"]').val(t),o.$form.submit()},exportHTML:function(){var o=this,r=o.clean("html"),n=o.cssFile&&o.cssFile.length?'<link href="'+o.cssFile+'" rel="stylesheet">':"",i=t.replace("{css}",n).replace("{data}",e("<div />").html(r.clone()).html());o.download("html",i)},exportTEXT:function(t){var o=this,r=o.clean(t),n=r.find("tr:has("+o.columns+")"),i=String.fromCharCode(11),l=String.fromCharCode(0),s='"'+o.colDelimiter+'"',a='"'+o.rowDelimiter+'"',h='"'+n.map(function(t,r){var n=e(r),l=n.find(o.columns);return l.map(function(t,o){var r=e(o),n=r.text();return n.replace('"','""')}).get().join(i)}).get().join(l).split(l).join(a).split(i).join(s)+'"';o.download(t,h)},exportEXCEL:function(){var t=this,r=t.clean("xls");r.find("input").remove();var n=t.cssFile&&t.cssFile.length?'<link href="'+t.cssFile+'" rel="stylesheet">':"",i=o.replace("{css}",n).replace("{worksheet}",t.worksheet).replace("{data}",e("<div />").html(r.clone()).html()).replace(/"/g,"'");t.download("xls",i)}},e.fn.gridexport=function(t){var o=Array.apply(null,arguments);return o.shift(),this.each(function(){var n=e(this),i=n.data("gridexport"),l="object"==typeof t&&t;i||n.data("gridexport",i=new r(this,e.extend({},e.fn.gridexport.defaults,l,e(this).data()))),"string"==typeof t&&i[t].apply(i,o)})},e.fn.gridexport.defaults={filename:"export",showHeader:!0,showPageSummary:!0,showFooter:!0,showCaption:!0,worksheet:"",colDelimiter:",",rowDelimiter:"\r\n",alertMsg:"",browserPopupsMsg:"",cssFile:"",exportConversions:{}}}(window.jQuery);
